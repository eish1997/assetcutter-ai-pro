# 提示词优化：效果分析 + 对比测试 结合方案 — 开发文档

> 记录者 D 根据判官 C 的裁决及 A/B 辩论整理。  
> 目标：在现有「提示词效果」模块之上，与 POPT 一期（快速对比测试器 + 获胜片段库）结合，形成统一、可落地的提示词优化能力。

---

## 1. 目标与定位

### 1.1 产品目标

- **统一心智**：提示词效果（事后分析）与对比测试（事中 A/B）同属「提示词优化」，在导航与话术上作为一类能力呈现。
- **一期形态**：双入口——「提示词效果」（只读分析页）、「提示词擂台」（快速对比测试 + 获胜片段库）；两入口同组、互相引流，**不**强制单页双 Tab。
- **数据分工**：生成记录与评分沿用 [PROMPT_SCORING_DESIGN.md](./PROMPT_SCORING_DESIGN.md)；对比选择与片段库单独存储，为二期统计与智能推荐留底。

### 1.2 一期不包含

- 强制性的多轮淘汰赛流程
- 复杂的实验树状态管理与可视化
- 变量的智能自动推荐
- 分析页「高分样本一键入片段库」（留二期）

### 1.3 与现有模块的关系

| 现有模块         | 角色                         | 结合方式                         |
|------------------|------------------------------|----------------------------------|
| 提示词效果（ADMIN） | 事后分析、统计、复现、导出   | 与「提示词擂台」并列入口，互相引流 |
| recordStore       | 生成记录读写                 | 不改动；对比选择另存              |
| 对话生图 / 提取花纹 | 生成记录来源                 | 不变                              |

---

## 2. 入口与导航

### 2.1 导航结构（一期）

- **分组**：侧栏中「提示词效果」与「提示词擂台」归入同一逻辑分组（如「提示词优化」或保持现有命名，在 UI 上相邻）。
- **入口 1 — 提示词效果**：维持现有入口，进入后为只读分析页（列表 / 复现模板 / 筛选 / 导出），见 [PROMPT_SCORING_DESIGN.md](./PROMPT_SCORING_DESIGN.md) 及现有实现。
- **入口 2 — 提示词擂台**：新入口，进入后为「快速对比测试」工作台（编辑框 + 选段 A/B → 生图对比 → 选胜者 → 存片段库），侧边栏或面板为「获胜片段库」。

### 2.2 互相引流

- 在**提示词效果**页提供入口或按钮：「去对比测试」→ 跳转至提示词擂台。
- 在**提示词擂台**页提供入口：「看效果分析」→ 跳转至提示词效果。

### 2.3 命名与引导

- 对比测试的正式名称建议为 **「提示词擂台」** 或 **「AB 审判台」**。
- 用户首次进入提示词擂台时，可展示一句短引导，例如：「选两段变体，看谁更出图。」

---

## 3. 核心用户流程（提示词擂台）

1. 用户在擂台页的**主编辑框**编写或修改提示词。
2. **高亮选中**一段文本（候选片段 A），点击工具栏的 **「对比测试」** 按钮。
3. 再**高亮选中**另一段文本（候选片段 B），系统弹出对比界面，左右并排生成图像（默认各 1 张，高级设置可调为 2 张）。
4. 用户点击选择**优胜侧**（左胜 / 右胜 / 平局可选）。
5. 若选了左胜或右胜，系统询问：「**将胜出片段保存至您的片段库？**」用户可选是/否。
6. 胜出片段**自动替换**编辑框中对应部分（替换为胜出侧文本）；若用户选择保存，则写入「获胜片段库」。
7. 片段库以列表或标签云形式常驻（侧边栏或面板），点击任意片段可**一键插入**编辑框当前光标位置。

**片段定义（一期）**：用户**手动选中**的文本。用户高亮一段为 A，再高亮一段为 B；不做自动识别。

---

## 4. 数据结构

### 4.1 对比选择记录（AB Choice）

用于静默沉淀每次对比的决策，供二期统计与智能推荐。

| 字段       | 类型   | 必填 | 说明                     |
|------------|--------|------|--------------------------|
| id         | string | 是   | 唯一 id                  |
| timestamp  | number | 是   | 选择时间戳               |
| snippetA   | string | 是   | 候选片段 A（用户选中的文本） |
| snippetB   | string | 是   | 候选片段 B               |
| winner     | 'A' \| 'B' \| 'tie' | 是 | 用户选择结果             |
| fullPromptA | string | 否   | 用于生图左侧的完整 prompt（可选，便于复现） |
| fullPromptB | string | 否   | 用于生图右侧的完整 prompt |
| reason     | string | 否   | 胜出原因（可选，用户填写或二期扩展） |

- **存储**：前端 `localStorage`，key 建议 `ac_ab_choices`；条数上限建议 **200**，写入时截断。
- **读写**：仅通过**抽象模块**（如 `abChoiceStore`）读写，业务代码不直接访问 key。

### 4.2 获胜片段库（Winning Snippets）

| 字段      | 类型   | 必填 | 说明           |
|-----------|--------|------|----------------|
| id        | string | 是   | 唯一 id        |
| text      | string | 是   | 片段文本       |
| timestamp | number | 是   | 入库时间       |
| source    | string | 否   | 预留：如 `ab_choice`，二期可加 `analysis` |

- **存储**：前端 `localStorage`，key 建议 `ac_winning_snippets`；条数上限建议 **100**，写入时截断。
- **读写**：仅通过**抽象模块**（如 `snippetStore`）读写。

---

## 5. 状态与交互约束

### 5.1 状态极简（一期）

- 当前编辑提示词（擂台页主编辑框内容）
- 片段库数组（从 `snippetStore` 加载）
- 最近一次对比结果（左图、右图、snippetA、snippetB、winner），用于展示与「替换 / 存库」操作

### 5.2 对比会话

- 每次对比在**临时弹层或副页**中完成，不直接改动主编辑框内容，直至用户点击「选择左侧/右侧」并确认替换。
- 选择后，再更新主编辑框（胜出片段替换对应选中部分）并可选写入片段库。

---

## 6. 验收标准（一期）

| 项 | 标准 |
|----|------|
| 入口 | 侧栏中「提示词效果」与「提示词擂台」同组展示，且两页互相有引流入口。 |
| 对比流程 | 用户能在**3 次操作内**发起一次 A/B 对比：选中 A → 点击「对比测试」→ 选中 B → 开始生成。 |
| 加载与反馈 | 对比界面从点击「开始」到左右图均显示，有明确进度反馈；目标加载时间取决于 API，建议等待时展示 loading/进度。 |
| 片段库 | 以列表或标签云形式常驻；点击片段可**一键插入**当前编辑框光标位置。 |
| 数据埋点 | 每次对比选择（snippetA、snippetB、winner、timestamp）静默写入 `ac_ab_choices`；存入片段库时写入 `ac_winning_snippets`。 |

---

## 7. 技术实现要点

### 7.1 抽象与存储

- **abChoiceStore**（或等价模块）：`loadChoices()`、`addChoice(record)`、内部处理排序与 200 条截断。
- **snippetStore**（或等价模块）：`loadSnippets()`、`addSnippet(snippet)`、`removeSnippet(id)`，内部处理 100 条截断。

### 7.2 生图与替换

- 对比时，用**同一套生图能力**（如现有 `dialogGenerateImage` 或贴图相关 API）：左侧用「将原提示词中 A 段替换为 A 的完整句」生成图，右侧用「替换为 B」生成图。若当前上下文是「对话生图」，则用对话生图 API；若为贴图场景，则用贴图 API；具体由产品上下文决定。
- 替换逻辑：用户选择胜出侧后，将编辑框中**对应选中的段落**替换为胜出侧文本（若选左胜则替换为 snippetA，右胜则为 snippetB）。

### 7.3 扩展预留

- 片段库条目预留 `source` 字段，便于二期增加「来自分析页精选」等来源。
- `ac_ab_choices` 结构保持可扩展（如增加 model、options 等），便于二期做统计与推荐。

---

## 8. 可执行清单（由 D 整理）

### 8.1 定稿与设计

- [ ] 定稿侧栏/导航：提示词效果、提示词擂台的命名、分组与顺序。
- [ ] 定稿「提示词擂台」编辑框承载方式：独立页 vs 嵌入现有某模式。
- [ ] 定稿对比选择与片段库的字段及 localStorage key（可与本文档 4.1、4.2 对齐后实现）。

### 8.2 实现

- [x] 实现 **abChoiceStore**：`ac_ab_choices` 的读写与截断。
- [x] 实现 **snippetStore**：`ac_winning_snippets` 的读写与截断。
- [x] 实现提示词擂台页：编辑框、选中 A/B、对比测试按钮、对比弹层（左右图、选择左/右/平局）、替换编辑框、存片段库确认。
- [x] 实现片段库面板：列表、点击插入光标、可选删除。
- [x] 在提示词效果页增加「去对比测试」入口；在提示词擂台页增加「看效果分析」入口。

### 8.3 验收与文档

- [ ] 按第 6 节验收标准做自测。
- [ ] 在 README 或 ARCHITECTURE 中简述「提示词优化」双入口与数据边界（可引用本文档）。

---

## 9. 擂台 V2：语言模型驱动迭代（当前主流程）

> 根据结构化辩论共识：用户用自然语言描述需求；语言模型生成 A/B 生图提示词；败者依胜者优化后再生图；循环直至用户满意并保存。

### 9.1 主流程

1. **入口**：用户输入**自然语言描述**（如「想要科技公司用的现代感 logo，简洁一点」）+ **底图**。
2. **首轮**：调用文本模型，根据描述生成**两条**给生图模型的英文提示词 **promptA**、**promptB**（主题一致、措辞或风格有差异）。用现有对话生图 API 分别生图，**并排展示**，并明确展示「提示词 A」「提示词 B」。用户**二选一**（选左/选右/平局）。
3. **后续轮**：**胜者**为擂主（championPrompt + championImage），**败者**为挑战者。调用文本模型**依胜者提示词优化败者**（指令：参考胜者优点局部改进败者，保持可区分差异，只输出一条英文生图提示词）。得到**新挑战者提示词**后，与擂主再次生图并排，用户再选；胜者更新擂主，败者进入下一轮优化，如此**循环**。
4. **终止**：用户点「**满意，保存**」→ 当前擂主提示词写入片段库；可选解析为结构化字段。或达到**轮次上限**（如 8 轮）后提示保存或重新开始。

### 9.2 API 约定

| 接口 | 入参 | 返回 | 说明 |
|------|------|------|------|
| **generateArenaABPrompts** | userDescription: string | { promptA: string, promptB: string } | 根据自然语言生成两条生图用英文提示词，主题一致、措辞/风格有差异；仅输出两条提示词，无 markdown。 |
| **optimizeLoserPrompt** | winnerPrompt: string, loserPrompt: string, userDescription?: string | string | 参考胜者优点局部改进败者，保持可区分差异；只输出一条纯英文生图提示词。 |

### 9.3 状态与约束

- **轮次上限**：单次擂台建议 5～8 轮，达上限后提示「可保存当前擂主或重新开始」。
- **本轮不优化**：可选提供「败者不优化、仅用当前败者提示词再生成一次」，用于排除随机性。
- **优化指令边界**：保持败者与胜者的可区分差异；只输出一条纯英文提示词。若连续多轮用户都选擂主，可提示「手动编辑或重新生成 A/B」作为出口。
- **保存**：擂主提示词必存；可选结构化（现有解析或轻量解析）。

### 9.4 数据埋点

- 每轮对比：snippetA/snippetB 存 promptA/promptB，winner、timestamp、fullPromptA/B 写入 `ac_ab_choices`。
- 保存时：擂主提示词写入 `ac_winning_snippets`（source 如 `arena_champion`）。

---

## 10. 风险与二期方向

- **风险**：若二期要做「分析页 → 片段库」，需在一期为片段库预留 `source` 或等价扩展，避免二期改表结构。
- **二期方向**：分析页高分样本/结构化片段「加入片段库」；基于 `ac_ab_choices` 的统计与智能推荐；多变量自动安排多轮对比的「自动化实验工作流」。

---

**文档版本**：V2（含擂台语言模型驱动迭代）  
**维护**：记录者 D；执行争议以判官 C 裁决与本文档为准。
